function OrderCloudSDKBuyerXP(e){e.decorator("OrderCloudSDK",["$delegate","bachBuyerXp","$q",function(e,r,t){return e.Buyers.Get=function(){var t=e.GetToken();return r.Get(t)},e.Buyers.List=function(){return e.Buyers.Get().then(function(e){return{Items:[e],Meta:{Page:1,PageSize:1,TotalPages:1,TotalCount:1,ItemRange:[1,1]}}})},e.Buyers.Update=function(){var n=[].slice.call(arguments)[1],a=e.GetToken();return n&&n.xp?r.Update(a,n.xp):t.reject("Missing body")},e.Buyers.Patch=function(){var n=[].slice.call(arguments)[1],a=e.GetToken();return n?r.Patch(a,n):t.reject("Missing body")},e}])}function lineItemThrottleDecorator(e){e.decorator("OrderCloudSDK",["$delegate","$q","$timeout",function(e,r,t){function n(){return v=!1,d.apply(e,arguments)}function a(){return v=!1,l.apply(e,arguments)}function i(){return v=!1,p.apply(e,arguments)}function o(){return v=!1,h.apply(e,arguments)}function c(){function n(){v=!0,f=!1,a()}function a(){t(function(){v=!1},3e3)}function i(){t(function(){f?i():o()},100)}function o(){m?c.reject(u):c.resolve(u)}var c=r.defer();return f?i():v?o():(f=!0,s.apply(e,arguments).then(function(e){u=e,m=!1,n(),o()}).catch(function(){m=!0,n(),o()})),c.promise}var u,s=e.LineItems.List,d=e.LineItems.Delete,l=e.LineItems.Update,p=e.LineItems.Patch,h=e.LineItems.Create,m=!1,f=!1,v=!1;return e.LineItems.List=c,e.LineItems.Delete=n,e.LineItems.Update=a,e.LineItems.Patch=i,e.LineItems.Create=o,e}])}function bachAssignments(e,r,t){function n(n){return r(e+"/assignments/usergroup",{},{call:{method:"POST",headers:{"oc-token":t.GetToken()}}}).call(n).$promise}var a={UserGroup:n};return a}function bachBuyerXpService(e,r,t,n){function a(n){function a(){var e=t(function(){s&&(t.cancel(e),i.resolve(s))},100)}var i=e.defer();return s?i.resolve(s):d?a():(d=!0,r.get(u,{headers:{"oc-token":n}}).then(function(e){s={xp:e.data},i.resolve(s)}).catch(function(e){i.reject(e)})),i.promise}function i(){return s}function o(e,t){return r.put(u,t,{headers:{"oc-token":e}}).then(function(e){var r={xp:e.data};return r})}function c(e,t){return r.patch(u,e,{headers:{"oc-token":t}}).then(function(e){var r={xp:e.data};return r})}var u=n+"/buyerxp",s=null,d=!1,l={Get:a,GetCache:i,Update:o,Patch:c};return l}function bachGiftCards(e,r,t,n,a){function i(e){return d().create(e).$promise}function o(e){return e.body||e.body.id?d().update({id:e.body.id},e.body).$promise:t.error("id is a required parameter")}function c(e){return d().delete({id:e.id}).$promise}function u(e){return d().list(e&&e.searchTerm?{searchTerm:e.searchTerm}:null).$promise.then(function(e){return e.list})}function s(r){return n.post(e+"/giftcards/purchase/"+r.orderid,{},{headers:{"oc-token":a.GetToken()}})}function d(){var t={create:{method:"POST"},update:{method:"PUT"},"delete":{method:"DELETE"},list:{method:"GET"}};return _.each(t,function(e){e.headers={"oc-token":a.GetToken()}}),r(e+"/giftcards/:id",{},t)}var l={Create:i,Update:o,Delete:c,List:u,Purchase:s};return l}function bachmansPurplePerks(e,r,t){function n(n){var a=new Date,i=t.defer(),o=new Date(a.getFullYear(),3*Math.ceil((a.getMonth()+1)/3),1)-1;return e.post("https://Four51TRIAL104401.jitterbit.net/BachmansOnPrem/PurplePerksBalanceCheck",{card_number:"777777"+n.xp.LoyaltyID}).then(function(e){var t={};e.data&&"cardNumber not available"!=e.data.card_value&&e.data.card_value>0?(t={Balance:Number(e.data.card_value),PointsEarned:e.data.card_value,CardNumber:"777777"+n.xp.LoyaltyID,LoyaltyID:n.xp.LoyaltyID,ExpirationDate:r("date")(o,"MM/dd/yyyy")},i.resolve(t)):(t={Balance:0,PointsEarned:0,CardNumber:"777777"+n.xp.LoyaltyID,LoyaltyID:n.xp.LoyaltyID,ExpirationDate:r("date")(o,"MM/dd/yyyy")},i.resolve(t))}).catch(function(e){console.log(e),i.reject(e)}),i.promise}var a={CheckBalance:n};return a}function bachShipmentsService(e,r,t,n,a,i,o,c){function u(e){var r=_.groupBy(e,function(e){var r="",t="";e.ShippingAddress&&(r=(e.ShippingAddress.FirstName+e.ShippingAddress.LastName).replace(/ /g,"").toLowerCase(),t=_.values(_.pick(e.ShippingAddress,"Street1","Street2","City","State","Zip","Country")).join("").replace(/ /g,"").toLowerCase());var n=e.xp.DeliveryDate||"",a=e.xp.Destination&&_.contains(["T","F","E"],e.xp.Destination),i=e.xp.DeliveryMethod||"",o=e.xp.Status||"Open";return r+t+n+i+o+a});return s(_.values(r))}function s(e){var r=[];return _.each(e,function(e){var t=_.filter(e,function(e){return _.some(e.xp,{DeliveryMethod:"InStorePickup"})}),n=_.groupBy(e,function(e){return t?e.xp.ProductFromStore:void 0});_.each(n,function(e){r.push(e)})}),d(r)}function d(e){return _.each(e,function(r,t){_.each(r,function(n,a){if(n.Product.xp.isWorkshopEvent&&r.length>1){var i=e[t].splice(a,1);e.push(i)}})}),l(e)}function l(e){var r=[];return _.each(e,function(e){var t=a.GetCache().xp.wireOrder.OutgoingOrders;n.DetermineEithers(e,t);var i=_.groupBy(e,function(e){return e.xp.Destination});_.each(i,function(e,n){var a="F"===n||"T"===n;a&&_.each(e,function(r){_.each(r.xp.deliveryFeesDtls,function(e,t){var n=["LocalDelivery","Standard Delivery","InStorePickUp","Courier","USPS","UPS Charges","Event"];_.contains(n,t)&&(r.xp.deliveryFeesDtls[t]=0),_.contains(["Wired Delivery Charges"],["Wired Service Charges"])&&(r.xp.deliveryFeesDtls[t]=0)}),e[0].xp.deliveryFeesDtls||(e[0].xp.deliveryFeesDtls={}),e[0].xp.deliveryFeesDtls["Wired Delivery Charges"]=Number(t.WiredDeliveryFees),e[0].xp.deliveryFeesDtls["Wired Service Charges"]=Number(t.WiredServiceFees)}),r.push(e)})}),p(r)}function p(e){return _.each(e,function(e){e.Cost=0,e.Tax=0,e.deliveryFeesDtls={};var r=0,t=0,n=0;_.each(e,function(a){a.xp&&(a.xp.Tax=a.xp.Tax||0,e.Cost=T(e.Cost,a.LineTotal),e.Tax=T(e.Tax,a.xp.Tax)),_.each(a.xp.deliveryFeesDtls,function(a,i){_.contains(["LocalDelivery","Standard Delivery","InStorePickUp","Courier","USPS","UPS Charges","Event"],i)?r=T(r,a):_.contains(["Wired Delivery Charges","Wired Service Charges"],i)?t=T(t,a):n=T(n,a),e.deliveryFeesDtls[i]=e.deliveryFeesDtls[i]?T(e.deliveryFeesDtls[i],a):a})}),e.DeliveryCharges=n+(t||r),e.Total=T(e.Cost,e.Tax,e.DeliveryCharges)}),e}function h(e,r){var n=u(e),a=_.flatten(n);return _.each(a,function(e){if("F"===e.xp.Destination||"T"===e.xp.Destination){var n="BachmanStoreFront"===c;t.LineItems.Patch(n?"outgoing":"incoming",r,e.ID,{xp:{deliveryFeesDtls:e.xp.deliveryFeesDtls}})}}),n}function m(t,n){var a=h(t,n.ID),i=[];return _.each(a,function(e,t){var a=[];_.each(e,function(e){a.push({OrderID:n.ID,LineItemID:e.ID,QuantityShipped:e.Quantity})});var o=t+1,c=e[0],u={BuyerID:r,ID:n.ID+"-"+(10>o?"0":"")+o,DateDelivered:null,Cost:e.Cost,Items:a,xp:{Status:g(c),PrintStatus:"OnHold"===g(c)?"NotNeeded":"NotPrinted",Direction:"Outgoing",DeliveryMethod:P(c),DateSubmitted:y(n.DateSubmitted),RequestedDeliveryDate:y(c.xp.DeliveryDate),addressType:c.xp.addressType,RecipientName:c.ShippingAddress?c.ShippingAddress.FirstName+" "+c.ShippingAddress.LastName:"N/A",Sender:x(n),FromUserID:n.FromUserID,CardMessage:D(e),CSRID:n.xp.CSRID||"Web",Tax:e.Tax,DeliveryCharges:e.DeliveryCharges,RouteCode:c.xp.RouteCode||"N/A",TimePreference:c.xp.deliveryRun||"NO PREF",ShipTo:c.ShippingAddress,StoreNumber:S(c),EagleStoreNumber:C(c),HandlingCost:e.deliveryFeesDtls["Handling Charges"]||0,DeliveryNote:c.xp.deliveryNote||null}};i.push(f(n.ID,u))}),e.all(i)}function f(e,r){var n={orderID:e,Shipment:r};return i(o+"/shipments/create",{},{call:{method:"POST",headers:{"oc-token":t.GetToken()}}}).call(n).$promise}function v(r){var n={},a={pageSize:100,orderID:r};return t.Shipments.List(a).then(function(r){var a=[];return _.each(r.Items,function(e){a.push(function(){return t.Shipments.ListItems(e.ID).then(function(r){return e.Items=r.Items,_.each(r.Items,function(e){n[e.LineItemID]=e}),e})}())}),e.all(a).then(function(e){return _.each(e,function(r,t){_.each(r.Items,function(r,a){_.each(r.xp.AddExtraLineItemsList,function(r,i){e[t].Items[a].xp.AddExtraLineItemsList[i]=n[r]})})}),e})})}function g(e){return e.xp.Destination&&_.contains(["F","T"],e.xp.Destination)?"OnHold":e.xp.Status&&"OnHold"===e.xp.Status?"OnHold":e.xp.addressType&&_.contains(["Funeral","Church","Cemetary"],e.xp.addressType)?"OnHold":"New"}function y(e){if(e){var r=new Date(e),t=r.getFullYear(),n=r.getMonth()+1<10?"0"+(r.getMonth()+1):r.getMonth()+1,a=r.getDate()<10?"0"+r.getDate():r.getDate();return t+"-"+n+"-"+a}return"N/A"}function D(e){var r="";return _.each(e,function(e){e.CardMessage&&e.CardMessage.length&&e.CardMessage.length>r.length&&(r=e.CardMessage)}),r||null}function x(e){var r="299999"===e.FromUserID,t=_.pick(e.BillingAddress,["FirstName","LastName","CompanyName","City","State","Zip","Phone"]);if(e.BillingAddress&&e.BillingAddress.xp&&e.BillingAddress.xp.Email&&(t.Email=e.BillingAddress.xp.Email),!r){var n=_.pick(e.FromUser,"FirstName","LastName","Email","Phone");_.each(n,function(e,r){e&&(t[r]=e)})}return t}function S(e){return e.ShippingAddress&&e.ShippingAddress.xp&&e.ShippingAddress.xp.StoreNumber?e.ShippingAddress.xp.StoreNumber:"3"}function C(e){return e.ShippingAddress&&e.ShippingAddress.xp&&e.ShippingAddress.xp.EagleStoreNumber?e.ShippingAddress.xp.EagleStoreNumber:"3"}function P(e){return e.xp&&e.xp.Destination&&_.contains(["F","T"],e.xp.Destination)?"F"===e.xp.Destination?"FTD":"TFE":e.xp.DeliveryMethod}function T(){return _.reduce(arguments,function(e,r){return(100*e+100*r)/100},0)}var b={Group:u,GroupAndPatchLIs:h,Create:m,List:v};return b}function bachWiredOrdersService(e){function r(e,r){var c=t(e),u=_.groupBy(c,function(e){return e.xp.Destination});if(u.E&&u.E.length>0){var s,d=_.findWhere(r.Destinations,{Name:"FTD.com"}),l=_.findWhere(r.Destinations,{Name:"Teleflora.com"}),p=_.without(_.keys(u),"E");if(0===p.length)return s=n(d.OrderPercentage,l.OrderPercentage),a(e,s);if(1===p.length)return s=p[0],a(e,s);var h=d.OrderPercentage>l.OrderPercentage?d:l,m="F"===h.Type?l:d,f=i(u.E),v=i(u[h.Type]),g=i(u[m.Type]);return f+v>=h.MinOrderPrice?o(u.E,v,h).then(function(e){var r=i(e);return r+g>=m.MinOrderPrice?o(e,g,m).then(function(e){_.each(e,function(e){return s=n(d.OrderPercentage,l.OrderPercentage),a([e],s)})}):(s=h.Type,a(e,s))}):f+g>=m.MinOrderPrice?o(u.E,g,m).then(function(e){return e?(s=m.Type,a(e,s)):void 0}):(s=n(d.OrderPercentage,l.OrderPercentage),a(u.E,h.Type))}}function t(e){return e=angular.copy(e),_.each(e,function(e){var r=["F","T","E"];_.contains(r,e.Product.xp.CodeB4)&&"Y"===e.Product.xp.CodeB2&&"LocalDelivery"!==e.xp.DeliveryMethod?(e.xp.deliveryCharges=0,"F"===e.Product.xp.CodeB4&&(e.xp.Destination="FTD"),"T"===e.Product.xp.CodeB4&&(e.xp.Destination="TFE"),"E"===e.Product.xp.CodeB4&&(e.xp.Destination="E"),e.xp.Status="OnHold"):e.xp.Destination&&delete e.xp.Destination}),e}function n(e,r){var t,n=100*Math.random();return t=e&&r?r>e?n>=0&&e>=n?"F":"T":n>=0&&r>=n?"T":"F":!e&&r?"T":!r&&e?"F":n>50?"F":"T"}function a(e,r){_.each(e,function(e){e.xp.Destination=r})}function i(e){var r=_.pluck(e,"LineTotal");return _.reduce(r,function(e,r){return e+r},0)}function o(r,t,n){if(t>=n.MinOrderPrice)return e.when(r);var i=r.shift();return t+=i,a([i],n.Type),o(r,t,n.MinOrderPrice)}var c={DetermineEithers:r};return c}angular.module("bachmans-common",[]),OrderCloudSDKBuyerXP.$inject=["$provide"],angular.module("bachmans-common").config(OrderCloudSDKBuyerXP),lineItemThrottleDecorator.$inject=["$provide"],angular.module("bachmans-common").config(lineItemThrottleDecorator),bachAssignments.$inject=["nodeapiurl","$resource","OrderCloudSDK"],angular.module("bachmans-common").factory("bachAssignments",bachAssignments),bachBuyerXpService.$inject=["$q","$http","$interval","nodeapiurl"],angular.module("bachmans-common").factory("bachBuyerXp",bachBuyerXpService),bachGiftCards.$inject=["nodeapiurl","$resource","toastr","$http","OrderCloudSDK"],angular.module("bachmans-common").factory("bachGiftCards",bachGiftCards),bachmansPurplePerks.$inject=["$http","$filter","$q"],angular.module("bachmans-common").factory("bachPP",bachmansPurplePerks),bachShipmentsService.$inject=["$q","buyerid","OrderCloudSDK","bachWiredOrders","bachBuyerXp","$resource","nodeapiurl","appname"],angular.module("bachmans-common").factory("bachShipments",bachShipmentsService),bachWiredOrdersService.$inject=["$q"],angular.module("bachmans-common").factory("bachWiredOrders",bachWiredOrdersService);